name: Bump Meshery, Meshery Extensions and Meshery Cloud

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release Version"
        required: true
        default: "1.0.0"
        type: string
  workflow_run:
    workflows: [Publish Node.js Package]
    types:
      - completed

permissions:
  contents: read

jobs:
  info:
    runs-on: ubuntu-24.04
    outputs:
      release_version: ${{ steps.release_version.outputs.release_version }}
    steps:
      - name: Resolve release version
        id: release_version
        env:
          INPUT_RELEASE_VERSION: ${{ github.event.inputs.release_version }}
          WORKFLOW_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          release_version="$INPUT_RELEASE_VERSION"

          if [ -z "$release_version" ]; then
            candidate="$WORKFLOW_HEAD_BRANCH"
            if [[ "$candidate" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              release_version="$candidate"
            fi
          fi

          if [ -z "$release_version" ]; then
            api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest"
            tag_name=$(curl -sSf -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "$api_url" | jq -r '.tag_name')
            if [[ "$tag_name" != "null" && -n "$tag_name" ]]; then
              release_version="$tag_name"
            fi
          fi

          release_version="${release_version#v}"

          if [ -z "$release_version" ]; then
            echo "Release version could not be determined." >&2
            exit 1
          fi

          echo "release_version=$release_version" >> "$GITHUB_OUTPUT"
          echo "Resolved release version: $release_version"
  bump-meshery:
    runs-on: ubuntu-24.04
    needs: info
    if: ${{ needs.info.outputs.release_version && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    env:
      RELEASE_VERSION: ${{ needs.info.outputs.release_version }}
    steps:
      - name: Checkout Meshery code
        uses: actions/checkout@v6
        with:
          repository: meshery/meshery
          fetch-depth: 1
          token: ${{ secrets.GH_ACCESS_TOKEN }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: ui
        run: npm install @sistent/sistent@^${{ env.RELEASE_VERSION }}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          commit-message: Update to Sistent v${{ env.RELEASE_VERSION }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ env.RELEASE_VERSION }}'
          add-paths: |
            ui/package.json
            ui/package-lock.json
          body: |
            Update to Sistent v${{ env.RELEASE_VERSION }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false

  bump-meshery-extensions:
    runs-on: ubuntu-latest
    needs: info
    if: ${{ needs.info.outputs.release_version && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    env:
      RELEASE_VERSION: ${{ needs.info.outputs.release_version }}
    steps:
      - name: Checkout Meshery Extensions code
        uses: actions/checkout@v6
        with:
          repository: layer5labs/meshery-extensions
          fetch-depth: 1
          token: ${{ secrets.GH_ACCESS_TOKEN }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: meshmap
        run: npm install @sistent/sistent@^${{ env.RELEASE_VERSION }}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          commit-message: Update to Sistent v${{ env.RELEASE_VERSION }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ env.RELEASE_VERSION }}'
          add-paths: |
            meshmap/package.json
            meshmap/package-lock.json
          body: |
            Update to Sistent v${{ env.RELEASE_VERSION }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false

  bump-layer5:
    runs-on: ubuntu-latest
    needs: info
    if: ${{ needs.info.outputs.release_version && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    env:
      RELEASE_VERSION: ${{ needs.info.outputs.release_version }}

    steps:
      - name: Checkout Layer5 code
        uses: actions/checkout@v6
        with:
          repository: layer5io/layer5
          fetch-depth: 1
          token: ${{ secrets.GH_ACCESS_TOKEN }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        run: npm install @sistent/sistent@^${{ env.RELEASE_VERSION }} --legacy-peer-deps
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          commit-message: Bump sistent v${{ env.RELEASE_VERSION }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ env.RELEASE_VERSION }}'
          add-paths: |
            package.json
            package-lock.json
          body: |
            Update to Sistent v${{ env.RELEASE_VERSION }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false

  bump-meshery-cloud:
    runs-on: ubuntu-latest
    needs: info
    if: ${{ needs.info.outputs.release_version && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    env:
      RELEASE_VERSION: ${{ needs.info.outputs.release_version }}
    steps:
      - name: Checkout Meshery Extensions code
        uses: actions/checkout@v6
        with:
          repository: layer5io/meshery-cloud
          fetch-depth: 1
          token: ${{ secrets.GH_ACCESS_TOKEN }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: ui
        run: npm install @sistent/sistent@^${{ env.RELEASE_VERSION }}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          commit-message: Update to Sistent v${{ env.RELEASE_VERSION }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ env.RELEASE_VERSION }}'
          add-paths: |
            ui/package.json
            ui/package-lock.json
          body: |
            Update to Sistent v${{ env.RELEASE_VERSION }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false
