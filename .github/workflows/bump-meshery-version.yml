name: Bump Meshery, Meshery Extensions and Meshery Cloud

on:
  workflow_run:
    workflows: [Publish Node.js Package]
    types:
      - completed
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to use (optional, uses latest release if not provided)'
        required: false
        type: string

jobs:
  versions-check:
    runs-on: ubuntu-latest
    outputs:
      current: ${{ steps.current.outputs.VERSION }}
    steps:
      - name: Download Version (workflow_run trigger)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: version-number
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - name: Retrieve Version from artifact (workflow_run trigger)
        if: github.event_name == 'workflow_run'
        run: |
          echo "VERSION=$(cat ./number)" >> $GITHUB_OUTPUT
        id: current_workflow_run
      - name: Use provided tag or get latest release (workflow_dispatch trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            echo "VERSION=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            # Get latest release tag from GitHub API
            LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
            echo "VERSION=${LATEST_TAG}" >> $GITHUB_OUTPUT
          fi
        id: current_dispatch
      - name: Set final version
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "VERSION=${{ steps.current_workflow_run.outputs.VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${{ steps.current_dispatch.outputs.VERSION }}" >> $GITHUB_OUTPUT
          fi
        id: current
  bump-meshery:
    runs-on: ubuntu-latest
    needs: versions-check
    steps:
      - name: Checkout Meshery code
        uses: actions/checkout@v4
        with:
          repository: meshery/meshery
          fetch-depth: 1
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: ui
        run: npm install @sistent/sistent@${{needs.versions-check.outputs.current}}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
          commit-message: Update to Sistent v${{ needs.versions-check.outputs.current }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ needs.versions-check.outputs.current }}'
          add-paths: |
            ui/package.json
            ui/package-lock.json
          body: |
            Update to Sistent v${{ needs.versions-check.outputs.current }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false
  bump-meshery-extensions:
    runs-on: ubuntu-latest
    needs: versions-check
    steps:
      - name: Checkout Meshery Extensions code
        uses: actions/checkout@v4
        with:
          repository: layer5labs/meshery-extensions
          fetch-depth: 1
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: meshmap
        run: npm install @sistent/sistent@${{needs.versions-check.outputs.current}}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
          commit-message: Update to Sistent v${{ needs.versions-check.outputs.current }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{needs.versions-check.outputs.current }}'
          add-paths: |
            meshmap/package.json
            meshmap/package-lock.json
          body: |
            Update to Sistent v${{ needs.versions-check.outputs.current }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false
  bump-layer5:
            runs-on: ubuntu-latest
            needs: versions-check
            steps:
              - name: Checkout Layer5 code
                uses: actions/checkout@v4
                with:
                  repository: layer5io/layer5
                  fetch-depth: 1
                  token: ${{ secrets.RELEASEDRAFTER_PAT }}
              - uses: actions/setup-node@v4
                with:
                  node-version: '20.x'
                  cache: "npm"
                  cache-dependency-path: '**/package-lock.json'
              - name: Make changes to pull request
                run: npm install @sistent/sistent@${{needs.versions-check.outputs.current}} --legacy-peer-deps
              - name: Create Pull Request
                id: cpr
                uses: peter-evans/create-pull-request@v7
                with:
                  token: ${{ secrets.RELEASEDRAFTER_PAT }}
                  commit-message: Bump sistent v${{ needs.versions-check.outputs.current }} dependencies
                  committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
                  author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
                  signoff: true
                  branch: bump-sistent-bot
                  delete-branch: true
                  title: '[Chore]: Update to Sistent v${{ needs.versions-check.outputs.current }}'
                  add-paths: |
                    package.json
                    package-lock.json
                  body: |
                    Update to Sistent v${{ needs.versions-check.outputs.current }}

                    _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
                  assignees: l5io
                  draft: false
  bump-meshery-cloud:
    runs-on: ubuntu-latest
    needs: versions-check
    steps:
      - name: Checkout Meshery Extensions code
        uses: actions/checkout@v4
        with:
          repository: layer5io/meshery-cloud
          fetch-depth: 1
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: "npm"
          cache-dependency-path: '**/package-lock.json'
      - name: Make changes to pull request
        working-directory: ui
        run: npm install @sistent/sistent@${{needs.versions-check.outputs.current}}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASEDRAFTER_PAT }}
          commit-message: Update to Sistent v${{ needs.versions-check.outputs.current }} dependencies
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: bump-sistent-bot
          delete-branch: true
          title: '[Chore]: Update to Sistent v${{ needs.versions-check.outputs.current }}'
          add-paths: |
            ui/package.json
            ui/package-lock.json
          body: |
            Update to Sistent v${{ needs.versions-check.outputs.current }}

            _This pull request has been auto-generated by [l5io](http://github.com/l5io)_
          assignees: l5io
          draft: false
